<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <link rel="stylesheet" href="{{ url_for('static', filename='css/signup.css') }}">
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap@3.3.7/dist/css/bootstrap-theme.min.css"
    integrity="sha384-rHyoN1iRsVXV4nD0JutlnGaslCJuC7uwjduW9SVrLvRYooPp2bWYgmgJQIXwl/Sp" crossorigin="anonymous">
    <link href='https://unpkg.com/boxicons@2.1.4/css/boxicons.min.css' rel='stylesheet'>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Ubuntu:ital,wght@0,300;0,400;0,500;0,700;1,300;1,400;1,500;1,700&display=swap" rel="stylesheet">
    <title>{% block title %}Sign Up{% endblock %}</title>
</head>
<body>

<!-- Signup Form -->
<div class="signup-modal">
  <a href="/signup-options" class="modal-exit-btn" title="Close">✕</a>
  <div class="logo-container">
    <img src="{{ url_for('static', filename='assets/animated_logo.gif') }}" alt="Soteria Logo"/>
    <h1>SOTERIA</h1>
  </div>

  <div class="input-group"><label for="fname">FIRST NAME</label><input type="text" id="fname"></div>
  <div class="input-group"><label for="lname">LAST NAME</label><input type="text" id="lname"></div>
  <div class="input-group"><label for="email">EMAIL</label><input type="email" id="email"></div>
  <div class="input-group"><label for="email2">RE-ENTER EMAIL</label><input type="email" id="email2"></div>
  <div class="input-group"><label for="password">PASSWORD</label><input type="password" id="password"></div>
  <div class="input-group"><label for="password2">RE-ENTER PASSWORD</label><input type="password" id="password2"></div>

  <div class="checkbox-group">
    <input type="checkbox" id="termsCheckbox">
    <label for="termsCheckbox">
      I agree to the <a href="#" onclick="openTermsModal(event)">Terms & Conditions</a>
    </label>
  </div>

  <div class="button-group">
    <button class="btn" onclick="submitForm()">SIGN UP</button>
  </div>
</div>

<!-- Terms Modal -->
<div class="modal" id="termsModal">
  <div class="modal-content">
    <button class="close-btn" onclick="closeTermsModal()">✕</button>
    <div class="modal-title">TERMS OF SERVICE</div>
    <div class="terms-text">
      Terms and Conditions for Personal Information Collection and Application

      By submitting your application, you agree to the following:

      Purpose: Your personal information is collected to verify your identity, prevent fraud, and comply with legal requirements.

      Data Security: Your information is securely stored with encryption and accessed only by authorized personnel. It will not be shared without your consent unless required by law.

      Application Validity: Applications are valid for 6 months. You must reapply and resubmit required documents for re-verification after this period.

      User Responsibility: You agree to provide accurate information and update it promptly if needed.

      Fraud Prevention: Submitting false information will result in disqualification and may be reported to authorities.

      Retention: Your information is securely stored during the application period and deleted after a legally required retention period.

      Changes: We may update these terms, and continued use implies your acceptance of changes.

      For questions, contact us at soteria.solutions@gmail.com. By applying, you agree to these terms.
    </div>
  </div>
</div>

<!-- Terms Warning Modal -->
<div class="modal" id="warningModal">
  <div class="modal-content" style="text-align: center;">
    <button class="close-btn" onclick="closeWarning()">✕</button>
    <p>You must agree to the <a href="#" onclick="openTermsModal(event)">Terms & Conditions</a> to continue.</p>
  </div>
</div>

<!-- MFA Modal -->
<div class="modal" id="mfaModal">
  <div class="modal-content" style="text-align: center;">
    <button class="close-btn" onclick="closeMFAModal()">✕</button>
    <div class="modal-title">SIGN UP SUCCESSFUL!</div>
    <p>An email has been sent to you with a verification code.<br>Enter the 6-digit code below:</p>
    <div style="margin: 20px 0; display: flex; flex-direction: column; align-items: center; gap: 10px;">
      <input id="mfaInput" type="text" maxlength="6" placeholder="______" style="padding: 10px; font-size: 1.2rem; border-radius: 8px; border: none; width: 150px; text-align: center; letter-spacing: 6px;" />
      <button class="btn register" onclick="verifyMFA()">VERIFY</button>
    </div>
    <p id="mfaError" style="color: red; display: none;">Invalid code. Please try again.</p>
    <div style="margin-top: 10px;">
      <a href="#" style="color: #00e0c0;" onclick="resendCode()">resend code</a>
    </div>
  </div>
</div>

<!-- Success Animation Modal -->
<div class="modal" id="successModal">
  <div class="success-animation-content">
    <div class="checkmark-circle">
      <div class="background-circle"></div>
      <div class="checkmark"></div>
    </div>
    <p class="success-text">VERIFIED</p>
  </div>
</div>

<script>
let generatedMFA = "";

function openTermsModal(event) {
  event.preventDefault();
  document.getElementById("termsModal").style.display = "flex";
}
function closeTermsModal() {
  document.getElementById("termsModal").style.display = "none";
}
function closeWarning() {
  document.getElementById("warningModal").style.display = "none";
}
function closeMFAModal() {
  document.getElementById("mfaModal").style.display = "none";
  document.getElementById("mfaError").style.display = "none";
  document.getElementById("mfaInput").value = "";
}

async function submitForm() {
  const email = document.getElementById("email").value.trim();
  const checkbox = document.getElementById("termsCheckbox");
  if (!checkbox.checked) {
    document.getElementById("warningModal").style.display = "flex";
    return;
  }
  try {
    const res = await fetch("http://127.0.0.1:5001/send-mfa", {
      method: "POST",
      headers: { "Content-Type": "application/json" },
      body: JSON.stringify({ email })
    });
    const result = await res.json();
    if (result.success) {
      generatedMFA = result.code;
      document.getElementById("mfaModal").style.display = "flex";
      document.getElementById("mfaInput").value = "";
    } else {
      alert("⚠️ " + result.error);
    }
  } catch (err) {
    console.error(err);
    alert("Something went wrong while sending the code.");
  }
}

async function verifyMFA() {
  const input = document.getElementById("mfaInput").value.trim();
  const error = document.getElementById("mfaError");
  if (input === generatedMFA) {
    try {
      const res = await fetch("/complete-signup", {
        method: "POST",
        headers: { "Content-Type": "application/json" },
        body: JSON.stringify({
          firstName: document.getElementById("fname").value,
          lastName: document.getElementById("lname").value,
          email: document.getElementById("email").value,
          password: document.getElementById("password").value
        })
      });
      const result = await res.json();
      if (result.success) {
        document.getElementById("mfaModal").style.display = "none";
        document.getElementById("successModal").style.display = "flex";
        setTimeout(() => {
          window.location.href = "/dashboard";
        }, 2000);
      } else {
        alert("❌ Failed to complete signup: " + result.message);
      }
    } catch (e) {
      alert("Server error. Try again later.");
      console.error(e);
    }
  } else {
    error.style.display = "block";
  }
}

function resendCode() {
  generatedMFA = Math.floor(100000 + Math.random() * 900000).toString();
  console.log("New MFA code sent:", generatedMFA);
  alert("A new code has been sent to your email.");
}

// Button loading animation
  document.querySelectorAll('.login, .register').forEach(btn => {
    btn.addEventListener('click', function (e) {
      btn.classList.add('button-loading');
      setTimeout(() => {
        btn.classList.remove('button-loading');
      }, 2000);
    });
  });
</script>
</body>
</html>
